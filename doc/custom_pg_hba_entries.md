## Setting custom pg_hba.conf entries

Stolon manages the pg_hba.conf file entries. The first rules are generated by stolon to permit local keeper connections and remote replication connections since these are needed to ensure the correct operation of the cluster.

An example of this rules is:

```
local postgres suuser md5
local replication repluser md5
host all suuser 0.0.0.0/0 md5
host all suuser ::0/0 md5
host replication repluser 0.0.0.0/0 md5
host replication repluser ::0/0 md5
```

where `suuser` and `repluser` are the user define in the `stolon-keeper` options (`--pg-su-username` and `--pg-repl-username`).

The first two rules permits local unix socket connections from stolon to the local postgres managed instance. The other 4 rules permits replication (and pg_rewind connections as superuser) from the other instances.

Users can specify custom pg_hba.conf entries setting the [cluster_specification](cluster_spec.md) `pgHBA` option. It must be a list of strings containing additional pg_hba.conf entries. They will be added to the pg_hba.conf generated by stolon.

Since clients connection will pass through the stolon-proxy the host part of the entries should match at least the stolon-proxies source addresses. For the same reason it's not possible to directly filter by client. If you have clients that requires different accesses you should use different set of stolon proxies for every kind of access.

**NOTE**: these lines aren't validated so if some of them are wrong postgres will refuse to start or, on reload, will log a warning and ignore the updated pg_hba.conf file. Stolon will just check that the string doesn't contain newlines characters.

By default, if no custom pg_hba entries are defined (clusterpsec pgHBA option is null, not an empty list), to keep backward compatibility, stolon will add two rules to permit tcp (both ipv4 and ipv6) connections from every host to all dbs and usernames with md5 password authentication:

```
host all all 0.0.0.0/0 md5
host all all ::0/0 md5
```

# Disabling postgres default access rules

If you want to disable the default access rules managed by stolon and manually handle them you should set the `noDefaultAccessRules` clusterspec option to `true` and add the pg_hba.conf rules to the `pgHBA` clusterspec option.

In this mode only the rules needed for keeper communication with the managed postgres instance will be added. For example:

```
local postgres suuser md5
local replication repluser md5
```

**NOTE:** the stolon cluster won't correctly work if you don't correctly specify the minimal rules the let the other cluster instances to successfully replicate. Please don't open issues if they are related to missing rules.
